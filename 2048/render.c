#include "include/render.h"
#include "include/gameplay.h"
#include "include/matrix.h"
#include "include/tiva.h"

uint16_t tile_bitmaps[13][16] = {
    {
        // 2
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000110000000,
        0b0000001001000000,
        0b0000000010000000,
        0b0000000100000000,
        0b0000001111000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
    },
    {
        // 4
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000001001000000,
        0b0000001001000000,
        0b0000001111000000,
        0b0000000001000000,
        0b0000000001000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
    },
    {
        // 8
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000110000000,
        0b0000001001000000,
        0b0000000110000000,
        0b0000001001000000,
        0b0000000110000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
    },
    {
        // 16
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000010001100000,
        0b0000110010000000,
        0b0000010011100000,
        0b0000010010010000,
        0b0000111001100000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
    },
    {
        // 32
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0001110001100000,
        0b0000001010010000,
        0b0000110000100000,
        0b0000001001000000,
        0b0001110011110000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
    },
    {
        // 64
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000110010010000,
        0b0001000010010000,
        0b0001110011110000,
        0b0001001000010000,
        0b0000110000010000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
    },
    {
        // 128
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0001000110001100,
        0b0011001001010010,
        0b0001000010001100,
        0b0001000100010010,
        0b0011101111001100,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
    },
    {
        // 256
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0011001111001100,
        0b0100101000010000,
        0b0001001110011100,
        0b0010000001010010,
        0b0111101110001100,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
    },
    {
        // 512
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0111100100011000,
        0b0100001100100100,
        0b0111000100001000,
        0b0000100100010000,
        0b0111001110111100,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
    },
    {
        // 1024
        0b0000000000000000,
        0b0000000000000000,
        0b0000001000110000,
        0b0000011001001000,
        0b0000001001001000,
        0b0000001001001000,
        0b0000011100110000,
        0b0000000000000000,
        0b0000011001001000,
        0b0000100101001000,
        0b0000001001111000,
        0b0000010000001000,
        0b0000111100001000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
    },
    {
        // 2048
        0b0000000000000000,
        0b0000000000000000,
        0b0000011000110000,
        0b0000100101001000,
        0b0000001001001000,
        0b0000010001001000,
        0b0000111100110000,
        0b0000000000000000,
        0b0000100100110000,
        0b0000100101001000,
        0b0000111100110000,
        0b0000000101001000,
        0b0000000100110000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
    },
    {
        // 4096
        0b0000000000000000,
        0b0000000000000000,
        0b0000100100110000,
        0b0000100101001000,
        0b0000111101001000,
        0b0000000101001000,
        0b0000000100110000,
        0b0000000000000000,
        0b0000011000110000,
        0b0000100101000000,
        0b0000011101110000,
        0b0000000101001000,
        0b0000011000110000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
    },
    {
        // 8192
        0b0000000000000000,
        0b0000000000000000,
        0b0000011000100000,
        0b0000100101100000,
        0b0000011000100000,
        0b0000100100100000,
        0b0000011001110000,
        0b0000000000000000,
        0b0000011000110000,
        0b0000100101001000,
        0b0000011100010000,
        0b0000000100100000,
        0b0000011001111000,
        0b0000000000000000,
        0b0000000000000000,
        0b0000000000000000,
    },
};

MatrixColor tile_colors[13];

void render_tile(uint8_t x, uint8_t y, uint8_t num) {
    int i, j;

    MatrixColor colors[2] = {
        tile_colors[num - 1],
        matrix_color(0, 0, 0),
    };

    for (i = 0; i < 16; i++) {
        uint16_t row = tile_bitmaps[num - 1][i];
        for (j = 0; j < 16; j++) {
            uint16_t mask = 1 << (15 - j);
            int bit_value = (row & mask) ? 1 : 0;
            if (i % 15 == 0 && j % 15 == 0) {
                bit_value = 1;
            }
            matrix_draw_pixel(colors[bit_value], x + j, y + i);
        }
    }
}

void clear_tile(uint8_t x, uint8_t y) {
    int i, j;
    MatrixColor black = matrix_color(0, 0, 0);

    for (i = 0; i < 16; i++) {
        for (j = 0; j < 16; j++) {
            matrix_draw_pixel(black, x + j, y + i);
        }
    }
}

void render_board(uint8_t board[4][4]) {
    int y, x;
    for (y = 0; y < 4; y++) {
        for (x = 0; x < 4; x++) {
            if (board[y][x] == 0) {
                clear_tile(x * 16, y * 16);
            } else {
                render_tile(x * 16, y * 16, board[y][x]);
            }
        }
    }
}

void render_init_colors() {
    tile_colors[0] = matrix_color(5, 3, 5);   // 2
    tile_colors[1] = matrix_color(6, 1, 6);   // 4
    tile_colors[2] = matrix_color(10, 0, 15);  // 8
    tile_colors[3] = matrix_color(2, 13, 14); // 16
    tile_colors[4] = matrix_color(1, 5, 11);  // 32
    tile_colors[5] = matrix_color(0, 2, 15);  // 64
    tile_colors[6] = matrix_color(15, 5, 1);  // 128
    tile_colors[7] = matrix_color(14, 5, 0);  // 256
    tile_colors[8] = matrix_color(15, 1, 0);  // 512
    tile_colors[9] = matrix_color(5, 1, 1);   // 1024
    tile_colors[10] = matrix_color(0, 5, 1);  // 2048
    tile_colors[11] = matrix_color(1, 5, 0);  // 4096
    tile_colors[12] = matrix_color(1, 0, 5);  // 8192
}

MatrixColor render_get_color(uint8_t tile_num) {
    if (tile_num == 0) {
        return matrix_color(0, 0, 0);
    }
    tile_num -= 1; // `tile_colors` is 0 indexed

    assert(tile_num < 13);
    return tile_colors[tile_num];
}
